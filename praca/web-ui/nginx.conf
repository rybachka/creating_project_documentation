# /etc/nginx/conf.d/default.conf
server {
  listen 80;

  # --- uploady (ZIP) ---
  client_max_body_size    50m;
  client_body_timeout     300s;

  # --- globalne timeouty proxy (możesz dostosować) ---
  proxy_connect_timeout   900s;
  proxy_send_timeout      900s;
  proxy_read_timeout      900s;
  send_timeout            900s;

  # pliki statyczne / SPA
  root   /usr/share/nginx/html;
  index  index.html;

  location / {
    try_files $uri /index.html;
  }

  # --- JAVA → Spring Boot ---
  location /api/ {
    proxy_pass                http://java-api:8080;   # zachowuje /api/... po stronie Javy
    proxy_http_version        1.1;

    # nagłówki forwardowane
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Prefix /api;

    # (opcjonalnie) buforowanie odpowiedzi — zostaw domyślne dla Javy
  }

  # --- Python NLP → FastAPI ---
  # Uwaga: trailing slash w proxy_pass usuwa prefix /nlp/ (np. /nlp/describe → /describe)
  location /nlp/ {
    proxy_pass                http://python-nlp:8000/;
    proxy_http_version        1.1;

    # NLP potrafi generować dłużej – dajemy dłuższy read timeout i brak buforowania
    proxy_read_timeout        600s;
    proxy_send_timeout        600s;

    # wyłącz buforowanie, żeby nie trzymać dużych payloadów w Nginx
    proxy_buffering           off;
    proxy_request_buffering   off;

    # nagłówki forwardowane
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Prefix /nlp;
  }

  # Swagger UI i OpenAPI z Javy
  location /swagger-ui/ {
    proxy_pass http://java-api:8080/swagger-ui/;
  }
  location /v3/ {
    proxy_pass http://java-api:8080/v3/;
  }
}
